# **ftail: 並行ログ監視ツール**

ftail は、複数のログファイルを同時に監視・追跡するためのコマンドラインツールです。特に、ログファイルが頻繁にローテーション、作成、または削除される環境において、tail \-F のより柔軟な代替として設計されています。このツールは、グロブパターンをサポートし、新しいファイルを自動的に検出し、シンボリックリンクも適切に処理します。

### **機能**

* **グロブパターンサポート**: /var/log/\*\*/\*.log のようなおなじみのグロブパターンを使用して、複数のファイルを監視できます。
* **シンボリックリンク解決**: シンボリックリンクを経由してアクセスされるファイルも正確に追跡し、重複して監視することを防ぎます。
* **リアルタイムファイル監視**: fsnotify を使用して、監視対象ディレクトリ内でのファイルの作成、削除、名前変更を即座に検知します。
* **定期スキャン**: fsnotify のイベントが漏れた場合に備え、定期的に新しいファイルをスキャンするフォールバックメカニズムを備えています。
* **リソース効率**: ポーリングごとにファイルをオープン・クローズすることでファイルディスクリプタを管理するため、多数の非アクティブなファイルがある環境に適しています。

### **ビルド方法**

ftail の実行ファイルをビルドするには、Goコンパイラがインストールされている必要があります。以下のコマンドで、必要な依存関係を取得し、軽量で最適化されたバイナリを作成します。


```shell
# 必要な依存関係を取得
# モジュールの依存関係を取得・整理します。

go mod tidy
```


```shell
# サイズとパフォーマンスを最適化して実行ファイルをビルド
# プログラムをコンパイルします。
# -ldflags="-s -w" は、シンボルテーブルとデバッグ情報をバイナリから削除し、最終的なバイナリサイズを大幅に削減します。

go build -ldflags='-s -w' -o ftail .
```

### **使用方法**

コンパイルしたバイナリを、1つ以上のグロブパターンを引数として実行します。ポーリング間隔やスキャン間隔はフラグでカスタマイズできます。

```
# グロブパターンを使用した実行例  
./ftail "/var/log/nginx/*.log" "/var/log/apache2/*.access.log"

# カスタム間隔での実行例  
./ftail --poll-interval 250ms --scan-interval 5s "/var/log/**/*.log"
```

#### **コマンドラインフラグ**

| フラグ              | デフォルト | 説明                                                   |
|:-----------------|:------|:-----------------------------------------------------|
| \--poll-interval | 500ms | 監視中のファイルに新しいコンテンツがないかポーリングする間隔。                      |
| \--scan-interval | 3s    | グロブパターンにマッチする新しいファイルをスキャンする間隔。                       |
| \--disp-interval | 1m    | ファイルに変更がない場合に「変更なし」と表示する間隔。0 を指定すると、このメッセージは無効になります。 |

### **実装詳細**

ftail は、複数のファイル監視を効率的に処理するために、高い並行性を備えたアーキテクチャで構築されています。

* **メインアプリケーション状態**: 主要なロジックは app 構造体によって管理されます。これには、監視対象のファイルとディレクトリのリスト、fsnotify ウォッチャー、およびコマンドライン引数が含まれます。
* **並行処理**: アプリケーションは、主に3つのゴルーチンを起動します。
    1. handleDirEvents(): fsnotify イベント（作成、削除、名前変更）をリッスンし、ファイルシステムの変化にリアルタイムで反応します。
    2. pollFiles(): 定期的に各監視ファイルをポーリングし、新しいデータを読み込んで出力し、読み取りオフセットを更新します。
    3. scanForNewFiles(): fsnotify が見逃した可能性のある変更を捕捉するため、定期的に初期ファイル検索を再実行します。
* **スレッドセーフなデータ**: watchedFiles には sync.Map を使用し、明示的なロックなしで複数のゴルーチンからの安全な並行アクセスを保証します。
* **グロブパターン処理**: doublestar ライブラリを使用して、再帰的なワイルドカード (\*\*) を含む柔軟なグロブパターンを処理します。
* **エラー処理**: すべてのエラーメッセージと情報メッセージは、アプリケーションの主要な出力（ファイルの内容そのもの）と分離するために、log.Printf を使用して標準エラー出力 (os.Stderr) に出力されます。
